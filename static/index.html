<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SAT Practice</title>

<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">

<!-- ✅ MathJax: support ALL standard delimiters -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [
        ['$', '$'],
        ['\\(', '\\)']
      ],
      displayMath: [
        ['$$', '$$'],
        ['\\[', '\\]']
      ],
      processEscapes: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    },
    startup: {
      typeset: false
    }
  };
</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<style>
body {
  margin: 0;
  font-family: 'Merriweather', serif;
  background: #fafafa;
  color: #2a2a2a;
}
header {
  text-align: center;
  padding: 60px 20px;
  background: white;
  border-bottom: 1px solid #eee;
}
.container {
  max-width: 900px;
  margin: 40px auto;
  padding: 0 16px;
}
.card {
  background: white;
  padding: 40px;
  border-radius: 8px;
  border: 1px solid #ddd;
}
select, button {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  font-family: 'Merriweather', serif;
}
button {
  background: #2a2a2a;
  color: white;
  border: none;
  cursor: pointer;
}
button:disabled {
  background: #ccc;
  cursor: not-allowed;
}
.question-text {
  white-space: pre-wrap;
  line-height: 1.7;
  font-size: 1.05rem;
}
.choice {
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 14px 16px;
  margin: 12px 0;
  cursor: pointer;
  transition: 0.15s;
}
.choice:hover { background: #f0f0f0; }
.choice.correct {
  background: #e8f5e9;
  border-color: #2e7d32;
}
.choice.incorrect {
  background: #fdecea;
  border-color: #c62828;
}
.loading {
  text-align: center;
  font-style: italic;
  color: #666;
}
.error {
  border: 1px solid #f3b0b0;
  background: #fff3f3;
  padding: 14px 16px;
  border-radius: 6px;
  white-space: pre-wrap;
}
</style>
</head>

<body>

<header>
  <h1>SAT Practice</h1>
</header>

<div class="container">
  <div class="card">

    <select id="section">
      <option value="">Select Section</option>
      <option value="Reading and Writing">Reading and Writing</option>
      <option value="Math">Math</option>
    </select>

    <select id="topic">
      <option value="">Select Topic</option>
    </select>

    <select id="difficulty">
      <option>Easy</option>
      <option selected>Medium</option>
      <option>Hard</option>
    </select>

    <button id="generate" disabled>Generate Question</button>

    <div id="output" style="margin-top:30px;"></div>

  </div>
</div>

<script>
const API_ORIGIN = location.origin;
const sectionEl = document.getElementById("section");
const topicEl = document.getElementById("topic");
const difficultyEl = document.getElementById("difficulty");
const btn = document.getElementById("generate");
const output = document.getElementById("output");

const TOPICS_BY_SECTION = {
  "Math": [
    "Algebra",
    "Advanced Math",
    "Problem-Solving and Data Analysis",
    "Geometry and Trigonometry"
  ],
  "Reading and Writing": [
    "Information and Ideas",
    "Craft and Structure",
    "Expression of Ideas",
    "Standard English Conventions"
  ]
};

function setTopicOptions(section) {
  topicEl.replaceChildren();
  const placeholder = document.createElement("option");
  placeholder.value = "";
  placeholder.textContent = "Select Topic";
  topicEl.appendChild(placeholder);

  (TOPICS_BY_SECTION[section] || []).forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    topicEl.appendChild(opt);
  });

  topicEl.disabled = !TOPICS_BY_SECTION[section];
  updateButton();
}

function updateButton() {
  btn.disabled = !(sectionEl.value && topicEl.value && difficultyEl.value);
}

sectionEl.onchange = () => setTopicOptions(sectionEl.value);
topicEl.onchange = updateButton;
difficultyEl.onchange = updateButton;

async function typeset(nodes) {
  await MathJax.startup.promise;
  MathJax.typesetClear(nodes);
  await MathJax.typesetPromise(nodes);
}

function parseModelText(text) {
  const q = text.match(/Question:\s*([\s\S]*?)Answer Choices:/)?.[1]?.trim() || "";
  const a = text.match(/Answer Choices:\s*([\s\S]*?)Correct Answer:/)?.[1]?.trim() || "";
  const c = text.match(/Correct Answer:\s*([A-D])/)?.[1] || "";
  const e = text.match(/Explanation:\s*([\s\S]*)$/)?.[1]?.trim() || "";

  const choices = a
    .split(/\n(?=[A-D]\.)/)
    .map(s => ({ letter: s[0], text: s.slice(2).trim() }))
    .filter(x => x.letter && x.text);

  return { q, choices, c, e };
}

btn.onclick = async () => {
  btn.disabled = true;
  output.innerHTML = `<div class="loading">Generating…</div>`;

  try {
    const resp = await fetch(`${API_ORIGIN}/api/generate-question`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        section: sectionEl.value,
        topic: topicEl.value,
        difficulty: difficultyEl.value
      })
    });

    const data = await resp.json();
    if (!resp.ok) throw new Error(data?.error || `Request failed (${resp.status})`);

    const { q, choices, c, e } = parseModelText(data.text || "");

    output.replaceChildren();

    const qDiv = document.createElement("div");
    qDiv.className = "question-text";
    qDiv.textContent = q;
    output.appendChild(qDiv);

    const choiceEls = [];
    for (const ch of choices) {
      const div = document.createElement("div");
      div.className = "choice";
      div.dataset.letter = ch.letter;
      div.textContent = `${ch.letter}. ${ch.text}`;
      output.appendChild(div);
      choiceEls.push(div);
    }

    const expl = document.createElement("div");
    expl.style.display = "none";
    expl.style.marginTop = "20px";
    expl.className = "question-text";
    expl.textContent = `Correct Answer: ${c}\n\n${e}`;
    output.appendChild(expl);

    await typeset([output]);

    choiceEls.forEach(el => {
      el.onclick = async () => {
        choiceEls.forEach(x => {
          x.style.pointerEvents = "none";
          x.classList.add(x.dataset.letter === c ? "correct" : "incorrect");
        });
        expl.style.display = "block";
        await typeset([expl]);
      };
    });

  } catch (err) {
    output.replaceChildren();
    const box = document.createElement("div");
    box.className = "error";
    box.textContent = String(err?.message || err);
    output.appendChild(box);
  } finally {
    updateButton();
  }
};

setTopicOptions("");
</script>

</body>
</html>
